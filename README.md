# MongoDB Finance Data Ingestion for Data Warehouse

This repository contains two Python scripts that automate the process of retrieving financial data from MongoDB Atlas, specifically invoice and line item details. The data is ingested into a MySQL data warehouse for visualization and analysis purposes.

## Overview

These scripts:
1. **Invoicing_Data_MongoDB.py** - Retrieves invoice data for two MongoDB organizations and inserts it into the `invoices` table.
2. **Invoice_Line_Items_MongoDB.py** - Retrieves line items associated with the latest invoices and inserts them into the `invoices_line_items` table.

Together, they enable comprehensive tracking and visualization of MongoDB finance data.

## Setup

### Prerequisites

1. **Python** - Ensure Python 3.7 or higher is installed.
2. **Libraries** - Install the following required libraries:
    ```bash
    pip install requests pandas mysql-connector-python
    ```
3. **Environment Variables** - Set up the required environment variables for MongoDB API access and MySQL connection details.

### Environment Variables

The following environment variables must be configured:

- MongoDB API Keys:
  - `mongodb_pk`
  - `mongodb_private_k`
  - `mongodb_org_id`
  - `mongodb_pk_2`
  - `mongodb_private_k_2`
  - `mongodb_org_id_2`

- MySQL Database Credentials:
  - `db_host_name`
  - `db_admin_user`
  - `db_admin_password`

### MySQL Database Structure

Create the following tables in MySQL:

#### invoices table

| Column                 | Type          | Description                                   |
|------------------------|---------------|-----------------------------------------------|
| `id`                   | VARCHAR(24)   | Primary Key, UUID of the invoice              |
| `org_id`               | VARCHAR(24)   | Organization ID                               |
| `created`              | DATETIME      | Invoice creation date                         |
| `start_date`           | DATETIME      | Invoice start date                            |
| `end_date`             | DATETIME      | Invoice end date                              |
| `updated`              | DATETIME      | Last update date of the invoice               |
| `starting_balance_cents` | INT         | Starting balance in cents                     |
| `amount_billed_cents`  | INT           | Amount billed in cents                        |
| `amount_paid_cents`    | INT           | Amount paid in cents                          |
| `credits_cents`        | INT           | Credits applied in cents                      |
| `subtotal_cents`       | INT           | Subtotal in cents                             |
| `refunds`              | JSON          | Refund information                            |
| `sales_tax_cents`      | INT           | Sales tax in cents                            |
| `status_name`          | VARCHAR(45)   | Status of the invoice                         |

#### invoices_line_items table

| Column                 | Type          | Description                                   |
|------------------------|---------------|-----------------------------------------------|
| `id`                   | VARCHAR(255)  | Primary Key, UUID generated by MySQL          |
| `group_id`             | VARCHAR(24)   | Group ID associated with the invoice          |
| `invoice_id`           | VARCHAR(24)   | Foreign Key linking to `invoices` table       |
| `cluster_name`         | VARCHAR(45)   | Name of the cluster                           |
| `group_name`           | VARCHAR(45)   | Name of the group                             |
| `sku`                  | VARCHAR(256)  | SKU associated with the line item             |
| `created`              | DATETIME      | Line item creation date                       |
| `start_date`           | DATETIME      | Line item start date                          |
| `end_date`             | DATETIME      | Line item end date                            |
| `quantity`             | FLOAT         | Quantity                                      |
| `unit`                 | VARCHAR(45)   | Unit of measure                               |
| `unit_price_dollars`   | FLOAT         | Price per unit in dollars                     |
| `total_price_cents`    | INT           | Total price in cents                          |
| `stitch_app_name`      | VARCHAR(45)   | Associated app name                           |
| `note`                 | VARCHAR(45)   | Additional note                               |
| `feature`              | VARCHAR(45)   | Feature associated with the line item         |
| `metric_date`          | DATETIME      | Metric date for the line item                 |

## Usage

1. **Invoicing_Data_MongoDB.py**
   - This script retrieves the main invoice data for two MongoDB organizations.
   - Run the script with:
     ```bash
     python Invoicing_Data_MongoDB.py
     ```
   - The script will:
     - Fetch invoice data from MongoDB.
     - Convert dates to MySQL format.
     - Remove any invoices in MySQL that match by `id` to avoid duplicates.
     - Insert new invoice data into the `invoices` table.

2. **Invoice_Line_Items_MongoDB.py**
   - This script retrieves detailed line item data for each invoice.
   - Run the script with:
     ```bash
     python Invoice_Line_Items_MongoDB.py
     ```
   - The script will:
     - Retrieve the latest invoices from MySQL.
     - Fetch line item data associated with these invoices from MongoDB.
     - Convert date fields to MySQL format.
     - Remove existing line items matching by `invoice_id` in MySQL to avoid duplicates.
     - Insert new line item data into the `invoices_line_items` table.

## Output

- **CSV Files**: Both scripts save the retrieved data as CSV files in the current directory for easy access and verification.
- **Database Tables**: All processed data is inserted into MySQL tables `invoices` and `invoices_line_items` for further analysis and visualization.

## Error Handling

Both scripts print error messages if there are issues connecting to MongoDB, retrieving data, or inserting data into MySQL.
